<html>
  <head>
    <title>homeq-satellite</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <meta name="robots" content="noindex" />
    <meta name="robots" content="nofollow" />

    <link
      rel="stylesheet"
      href="https://unpkg.com/gridjs/dist/theme/mermaid.min.css"
    />
  </head>
  <body>
    <main>
      <h1>homeq-satellite</h1>
      <p><a href="https://github.com/arthow4n/homeq-satellite">GitHub</a></p>
      <p>Last updated: <span id="lastUpdatedAt"></span></p>
      <p>Main filter:</p>
      <pre id="mainFilter"></pre>

      <p>
        Custom filters:
        <br />
        <label
          >Cities/Municipalities (split by ,): <input id="cities-input"
        /></label>
        <br />
        <label
          >Base coordinate (latitude,lontitude) used for calculating distance:
          <input id="base-coord-input"
        /></label>
        <br />
        <label>Max rent: <input id="max-rent-input" /></label>
        <br />
        <label
          >In queue since (show only apartments that meet queue day requirements
          to be in top 10 applicants) (yyyy-MM-dd):
          <input id="in-queue-since-input" />
          <span id="in-queue-for-days"></span
        ></label>
      </p>
      <p>
        Search result count (custom filtered / main filtered / all results):
        <span id="search-result-count"></span>
      </p>
      <p>
        Hold shift and click on table header to use multiple columns for
        sorting.
      </p>
      <p>Showing custom filtered results:</p>
    </main>
    <script src="https://unpkg.com/gridjs/dist/gridjs.umd.js"></script>
    <script>
      const enRelativeTimeFormat = new Intl.RelativeTimeFormat("en-GB");
      const defaultBaseCoord = { lat: 57.707374, lng: 11.939192 };
      const defaultMaximumRent = 999999;
      const defaultCities = "Göteborg,Mölndal";

      const mainFilter = (x) => {
        return x
          .filter((r) => !r.short_lease)
          .filter((r) => !["student", "senior"].includes(r.audience));
      };

      const openExternalLink = (link) => {
        window.open(link, "_blank", "noopener,noreferrer");
      };

      const openSearchResult = (r) => {
        openExternalLink(`https://www.homeq.se/lagenhet/${r.id}`);
        if (r.floor_plan) {
          window.open(r.floor_plan, "_blank", "noopener,noreferrer");
        }
      };

      // Modified from https://stackoverflow.com/a/1502821
      const getDistance = function (p1lat, p1lng, p2lat, p2lng) {
        const rad = function (x) {
          return (x * Math.PI) / 180;
        };

        const R = 6378137; // Earth’s mean radius in meter
        const dLat = rad(p2lat - p1lat);
        const dLong = rad(p2lng - p1lng);
        const a =
          Math.sin(dLat / 2) * Math.sin(dLat / 2) +
          Math.cos(rad(p1lat)) *
            Math.cos(rad(p2lat)) *
            Math.sin(dLong / 2) *
            Math.sin(dLong / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        const d = R * c;
        return d; // returns the distance in meter
      };

      const calculateInQueueForDaysFromStringDate = (s) => {
        return /[0-9][0-9][0-9][0-9]-[0-9][0-9]-[0-9][0-9]/.test(s)
          ? Math.floor((Date.now() - new Date(s)) / 1000 / 60 / 60 / 24)
          : null;
      };

      const link = (children, href) =>
        gridjs.h(
          "a",
          {
            href,
            target: "_blank",
            rel: "noopener noreferrer",
          },
          children
        );

      const postalCodeCityNameMappingPromise = fetch(
        "/sweden-postal-code-city-name-mapping/postalcodes.json"
      ).then((res) => res.json());

      fetch("./searchResults.json")
        .then((res) => res.json())
        .then(
          async ({ lastUpdatedAt, searchResults: unsortedSearchResults }) => {
            const postalCodeCityNameMapping =
              await postalCodeCityNameMappingPromise;

            const getStreetNameNumberZipFromResult = (r) => {
              const cityName =
                postalCodeCityNameMapping[
                  r.address.zip.replace(/[^0-9]/g, "")
                ] || r.address.municipality;
              return `${r.address.street} ${r.address.street_number}, ${r.address.zip} ${cityName}`;
            };
            const searchResults = unsortedSearchResults.sort((a, b) => {
              return b.publish_date.localeCompare(a.publish_date, "sv");
            });

            window.searchResults = searchResults;
            const lastUpdatedAtDate = new Date(lastUpdatedAt);
            const minutesSinceLastUpdated = Math.ceil(
              (lastUpdatedAtDate - Date.now()) / 1000 / 60
            );
            document.getElementById(
              "lastUpdatedAt"
            ).innerText = `${lastUpdatedAtDate.toLocaleString()} (${
              minutesSinceLastUpdated >= 90
                ? enRelativeTimeFormat.format(
                    Math.ceil(minutesSinceLastUpdated / 60),
                    "hour"
                  )
                : enRelativeTimeFormat.format(minutesSinceLastUpdated, "minute")
            })`;
            document.getElementById("mainFilter").innerText = mainFilter
              .toString()
              .split("\n")
              .slice(1, -1)
              .join("\n");

            const tableDiv = document.createElement("div");
            document.body.appendChild(tableDiv);

            const parseLatLng = (value) => {
              const [lat, lng] = (
                value?.replace(/[^\d,.]/g, "").split(",") ?? []
              ).map((s) => parseFloat(s));

              if (
                typeof lat !== "number" ||
                typeof lng !== "number" ||
                Number.isNaN(lat) ||
                Number.isNaN(lng)
              )
                return;

              return { lat, lng };
            };

            const getGridConfig = () => {
              const searchParams = new URL(location).searchParams;

              const citiesSrc = searchParams.get("cities");
              const cities = /[\p{L},]+/u.test(citiesSrc)
                ? citiesSrc.split(",").map((x) => x.toLocaleLowerCase("sv"))
                : null;
              const baseCoord =
                parseLatLng(searchParams.get("base-coord")) || defaultBaseCoord;

              const maxRentSrc = parseInt(searchParams.get("max-rent"), 10);
              const maxRent = Number.isNaN(maxRentSrc)
                ? defaultMaximumRent
                : maxRentSrc;

              const inQueueSinceSrc = searchParams.get("in-queue-since");
              const inQueueForDays =
                calculateInQueueForDaysFromStringDate(inQueueSinceSrc);

              const getQueueDaysFromResult = (r) =>
                r.sorting_mode === "random"
                  ? -1
                  : r.$object_ad
                  ? r.$object_ad.last_accept
                  : Infinity;

              const mainFiltered = mainFilter(searchResults);
              const customFiltered = mainFiltered
                .filter((r) => {
                  return (
                    cities === null ||
                    cities.includes(
                      (r.address.city ?? "").trim().toLocaleLowerCase("sv")
                    ) ||
                    cities.includes(
                      (r.address.municipality ?? "")
                        .trim()
                        .toLocaleLowerCase("sv")
                    ) ||
                    cities.includes(
                      postalCodeCityNameMapping[
                        r.address.zip.replace(/[^0-9]/g, "")
                      ]?.toLocaleLowerCase("sv")
                    )
                  );
                })
                .filter((r) => r.rent <= maxRent)
                .filter(
                  (r) =>
                    inQueueForDays === null ||
                    getQueueDaysFromResult(r) <= inQueueForDays
                );
              document.querySelector(
                "#search-result-count"
              ).innerText = `${customFiltered.length}/${mainFiltered.length}/${searchResults.length}`;

              return {
                style: {
                  table: {
                    width: "100%",
                  },
                },
                sort: {
                  enabled: true,
                  multiColumn: true,
                },
                pagination: {
                  enabled: true,
                  limit: 1000,
                  summary: true,
                },
                columns: [
                  {
                    name: "Address",
                    formatter: (r) => {
                      const address = getStreetNameNumberZipFromResult(r);
                      return gridjs.h("span", {}, [
                        link(address, `https://www.homeq.se/lagenhet/${r.id}`),
                        " (",
                        link(
                          "Map",
                          `https://www.google.com/maps/place/${encodeURIComponent(
                            address
                          )}/`
                        ),
                        r.floor_plan ? ", " : "",
                        r.floor_plan ? link("Plan", r.floor_plan) : "",
                        ")",
                      ]);
                    },
                  },
                  {
                    name: "Distance",
                    width: "150px",
                    formatter: (r) => {
                      const distance = getDistance(
                        baseCoord.lat,
                        baseCoord.lng,
                        r.location.lat,
                        r.location.lon
                      );

                      const inrad = Math.atan2(
                        r.location.lat - baseCoord.lat,
                        r.location.lon - baseCoord.lng
                      );
                      // https://stackoverflow.com/a/1311134
                      const degreeFromEast =
                        ((inrad > 0 ? inrad : 2 * Math.PI + inrad) * 360) /
                        (2 * Math.PI);
                      const flooredDegreeFromNorth =
                        (90 - Math.floor(degreeFromEast) + 360) % 360;

                      const text = gridjs.h("span", {}, [
                        gridjs.h(
                          "span",
                          {
                            style: `display: inline-block; transform: rotate(${flooredDegreeFromNorth}deg)`,
                          },
                          ["🡹"]
                        ),
                        `${(distance / 1000).toFixed(1)} km `,
                      ]);

                      return link(
                        text,
                        `https://www.google.com/maps/dir/?api=1&travelmode=bicycling&origin=${encodeURIComponent(
                          baseCoord.lat
                        )},${encodeURIComponent(
                          baseCoord.lng
                        )}&destination=${encodeURIComponent(
                          // Use zip code for destination for better navigation result
                          getStreetNameNumberZipFromResult(r)
                        )}`
                      );
                    },
                    sort: {
                      compare: (a, b) =>
                        getDistance(
                          baseCoord.lat,
                          baseCoord.lng,
                          a.location.lat,
                          a.location.lon
                        ) -
                        getDistance(
                          baseCoord.lat,
                          baseCoord.lng,
                          b.location.lat,
                          b.location.lon
                        ),
                    },
                  },
                  {
                    name: "Floor",
                    width: "120px",
                    formatter: (cell) => `${cell} F`,
                  },
                  {
                    name: "Rooms",
                    width: "120px",
                    formatter: (cell) => `${cell} rok`,
                  },
                  {
                    name: "Size",
                    width: "120px",
                    formatter: (cell) => `${cell} m2`,
                  },
                  {
                    name: "Rent",
                    width: "120px",
                    formatter: (cell) => `${cell} kr`,
                  },
                  {
                    name: "Queue req.",
                    width: "160px",
                    formatter: (cell) =>
                      cell === -1
                        ? "Random"
                        : `${cell === Infinity ? "Unknown" : cell} days`,
                  },
                  {
                    name: "Access",
                    width: "140px",
                  },
                  {
                    name: "Published",
                    width: "140px",
                  },
                ],
                data: customFiltered.map((r) => {
                  return [
                    r,
                    r,
                    Array.isArray(r.floor) ? r.floor.sort()[0] : r.floor,
                    Array.isArray(r.rooms) ? r.rooms.sort()[0] : r.rooms,
                    Array.isArray(r.area) ? r.area.sort()[0] : r.area,
                    Array.isArray(r.rent) ? r.rent.sort()[0] : r.rent,
                    getQueueDaysFromResult(r),
                    Array.isArray(r.access_date)
                      ? r.access_date.sort()[0]
                      : r.access_date,
                    r.publish_date,
                  ];
                }),
              };
            };

            let grid;
            const setSearchParam = (key, value) => {
              var newUrl = new URL(location);
              newUrl.searchParams.set(key, value);

              history.replaceState(null, null, newUrl);
              grid && grid.updateConfig(getGridConfig()).forceRender();
            };

            {
              const citiesInput = document.querySelector("#cities-input");
              citiesInput.value =
                new URL(location).searchParams.get("cities") || defaultCities;
              setSearchParam("cities", citiesInput.value);

              citiesInput.addEventListener("change", (event) => {
                if (/[\p{L},]*/u.test(event.target.value)) {
                  setSearchParam("cities", event.target.value);
                }
              });
            }

            {
              const baseCoordInput =
                document.querySelector("#base-coord-input");
              baseCoordInput.value =
                new URL(location).searchParams.get("base-coord") ||
                `${defaultBaseCoord.lat}, ${defaultBaseCoord.lng}`;
              baseCoordInput.addEventListener("change", (event) => {
                const newLatLng = parseLatLng(event.target.value);
                if (newLatLng) {
                  setSearchParam(
                    "base-coord",
                    `${newLatLng.lat}, ${newLatLng.lng}`
                  );
                }
              });
            }

            {
              const maxRentInput = document.querySelector("#max-rent-input");
              maxRentInput.value =
                new URL(location).searchParams.get("max-rent") ||
                defaultMaximumRent;
              maxRentInput.addEventListener("change", (event) => {
                if (parseInt(event.target.value, 10) !== NaN) {
                  setSearchParam("max-rent", event.target.value);
                }
              });
            }

            {
              const inQueueForDaysSpan =
                document.querySelector("#in-queue-for-days");
              const inQueueSinceInput = document.querySelector(
                "#in-queue-since-input"
              );

              const renderQueueDays = () => {
                const days = calculateInQueueForDaysFromStringDate(
                  inQueueSinceInput.value
                );
                inQueueForDaysSpan.innerText =
                  days === null ? "" : `(=in queue for ${days} days)`;
              };

              inQueueSinceInput.value =
                new URL(location).searchParams.get("in-queue-since") || "";
              renderQueueDays();

              inQueueSinceInput.addEventListener("change", (event) => {
                renderQueueDays();
                if (
                  /[0-9][0-9][0-9][0-9]-[0-9][0-9]-[0-9][0-9]/.test(
                    event.target.value
                  ) ||
                  !event.target.value
                ) {
                  setSearchParam("in-queue-since", event.target.value);
                }
              });
            }

            grid = new gridjs.Grid(getGridConfig()).render(tableDiv);
          }
        );
    </script>
  </body>
</html>
