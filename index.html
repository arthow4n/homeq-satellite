<html>
  <head>
    <title>homeq-satellite</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <meta name="robots" content="noindex" />
    <meta name="robots" content="nofollow" />

    <link
      rel="stylesheet"
      href="https://unpkg.com/gridjs/dist/theme/mermaid.min.css"
    />
  </head>
  <body>
    <main>
      <h1>homeq-satellite</h1>
      <p><a href="https://github.com/arthow4n/homeq-satellite">GitHub</a></p>
      <p>Last updated: <span id="lastUpdatedAt"></span></p>
      <p>Main filter:</p>
      <pre id="mainFilter"></pre>

      <ul>
        <li>
          Hold shift and click on table header to use multiple columns for
          sorting.
        </li>
        <li>
          -1 days of queue req. means the sorting mode is random, 9999 days
          means we didn't fetch the data for it.
        </li>
      </ul>
      <label
        >Base coordinate (latitude,lontitude) used for calculating distance:
        <input id="base-coord-input"
      /></label>
      <label>Max rent: <input id="max-rent-input" /></label>
    </main>
    <script src="https://unpkg.com/gridjs/dist/gridjs.umd.js"></script>
    <script>
      const defaultBaseCoord = { lat: 57.707374, lng: 11.939192 };
      const defaultMaximumRent = 999999;
      const mainFilter = (x) => {
        return x
          .filter((r) =>
            ["göteborg", "mölndal"].includes(
              r.address.city?.toLocaleLowerCase("sv")
            )
          )
          .filter((r) => !r.short_lease)
          .filter((r) => !["student", "senior"].includes(r.audience));
      };

      const openExternalLink = (link) => {
        window.open(link, "_blank", "noopener,noreferrer");
      };

      const openSearchResult = (r) => {
        openExternalLink(`https://www.homeq.se/lagenhet/${r.id}`);
        if (r.floor_plan) {
          window.open(r.floor_plan, "_blank", "noopener,noreferrer");
        }
      };

      // Modified from https://stackoverflow.com/a/1502821
      const getDistance = function (p1lat, p1lng, p2lat, p2lng) {
        const rad = function (x) {
          return (x * Math.PI) / 180;
        };

        const R = 6378137; // Earth’s mean radius in meter
        const dLat = rad(p2lat - p1lat);
        const dLong = rad(p2lng - p1lng);
        const a =
          Math.sin(dLat / 2) * Math.sin(dLat / 2) +
          Math.cos(rad(p1lat)) *
            Math.cos(rad(p2lat)) *
            Math.sin(dLong / 2) *
            Math.sin(dLong / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        const d = R * c;
        return d; // returns the distance in meter
      };

      fetch("./searchResults.json")
        .then((res) => res.json())
        .then(
          async ({ lastUpdatedAt, searchResults: unsortedSearchResults }) => {
            const searchResults = unsortedSearchResults.sort((a, b) => {
              return a.publish_date.localeCompare(b.publish_date, "sv") * -1;
            });

            window.searchResults = searchResults;
            const lastUpdatedAtDate = new Date(lastUpdatedAt);
            const hoursSinceLastUpdated = Math.floor(
              (lastUpdatedAtDate - Date.now()) / 1000 / 60 / 60
            );
            document.getElementById(
              "lastUpdatedAt"
            ).innerText = `${lastUpdatedAtDate.toLocaleString()} (${new Intl.RelativeTimeFormat().format(
              hoursSinceLastUpdated,
              "hour"
            )})`;
            document.getElementById("mainFilter").innerText = mainFilter
              .toString()
              .split("\n")
              .slice(1, -1)
              .join("\n");

            const tableDiv = document.createElement("div");
            document.body.appendChild(tableDiv);

            const parseLatLng = (value) => {
              const [lat, lng] = (
                value?.replace(/[^\d,.]/g, "").split(",") ?? []
              ).map((s) => parseFloat(s));

              if (
                typeof lat !== "number" ||
                typeof lng !== "number" ||
                Number.isNaN(lat) ||
                Number.isNaN(lng)
              )
                return;

              return { lat, lng };
            };

            const getGridConfig = () => {
              const searchParams = new URL(location).searchParams;

              const baseCoord =
                parseLatLng(searchParams.get("base-coord")) || defaultBaseCoord;

              const maxRentSrc = parseInt(searchParams.get("max-rent"), 10);
              const maxRent = Number.isNaN(maxRentSrc)
                ? defaultMaximumRent
                : maxRentSrc;

              return {
                style: {
                  table: {
                    width: "100%",
                  },
                },
                sort: {
                  enabled: true,
                  multiColumn: true,
                },
                pagination: {
                  enabled: true,
                  limit: 1000,
                  summary: true,
                },
                columns: [
                  {
                    name: "ID",
                    width: "100px",
                    formatter: (cell) => {
                      return gridjs.h(
                        "button",
                        {
                          className: "openSearchResult",
                          onclick: () => {
                            const r = searchResults.find((x) => x.id === cell);
                            openSearchResult(r);
                          },
                        },
                        cell
                      );
                    },
                  },
                  {
                    name: "Address",
                    formatter: (r) => {
                      const address = `${r.address.street} ${r.address.street_number}, ${r.address.municipality}`;
                      const link = (text, href) =>
                        gridjs.h(
                          "a",
                          {
                            href,
                            target: "_blank",
                            rel: "noopener noreferrer",
                          },
                          text
                        );

                      return gridjs.h("span", {}, [
                        link(
                          address,
                          `https://www.google.com/maps/place/${encodeURIComponent(
                            address
                          )}/`
                        ),
                        " (",
                        r.floor_plan ? link("Plan", r.floor_plan) : "",
                        r.floor_plan ? ", " : "",
                        link("HQ", `https://www.homeq.se/lagenhet/${r.id}`),
                        ")",
                      ]);
                    },
                  },
                  {
                    name: "Distance",
                    width: "150px",
                    formatter: (cell) => `+${(cell / 1000).toFixed(1)} km`,
                  },
                  {
                    name: "Floor",
                    width: "120px",
                    formatter: (cell) => `${cell} F`,
                  },
                  {
                    name: "Rooms",
                    width: "120px",
                    formatter: (cell) => `${cell} rok`,
                  },
                  {
                    name: "Size",
                    width: "120px",
                    formatter: (cell) => `${cell} m2`,
                  },
                  {
                    name: "Rent",
                    width: "120px",
                    formatter: (cell) => `${cell} kr`,
                  },
                  {
                    name: "Queue req.",
                    width: "160px",
                    formatter: (cell) => `${cell} days`,
                  },
                  {
                    name: "Access",
                    width: "140px",
                  },
                  {
                    name: "Published",
                    width: "140px",
                  },
                ],
                data: mainFilter(searchResults)
                  .filter((r) => r.rent <= maxRent)
                  .map((r) => {
                    return [
                      r.id,
                      r,
                      getDistance(
                        baseCoord.lat,
                        baseCoord.lng,
                        r.location.lat,
                        r.location.lon
                      ),
                      Array.isArray(r.floor) ? r.floor.sort()[0] : r.floor,
                      Array.isArray(r.rooms) ? r.rooms.sort()[0] : r.rooms,
                      Array.isArray(r.area) ? r.area.sort()[0] : r.area,
                      Array.isArray(r.rent) ? r.rent.sort()[0] : r.rent,
                      r.sorting_mode === "random"
                        ? -1
                        : r.$object_ad
                        ? r.$object_ad.last_accept
                        : 9999,
                      Array.isArray(r.access_date)
                        ? r.access_date.sort()[0]
                        : r.access_date,
                      r.publish_date,
                    ];
                  }),
              };
            };

            let grid;
            const setSearchParam = (key, value) => {
              var newUrl = new URL(location);
              newUrl.searchParams.set(key, value);

              history.replaceState(null, null, newUrl);
              grid && grid.updateConfig(getGridConfig()).forceRender();
            };

            {
              const baseCoordInput =
                document.querySelector("#base-coord-input");
              baseCoordInput.value =
                new URL(location).searchParams.get("base-coord") ||
                `${defaultBaseCoord.lat}, ${defaultBaseCoord.lng}`;
              baseCoordInput.addEventListener("change", (event) => {
                const newLatLng = parseLatLng(event.target.value);
                if (newLatLng) {
                  setSearchParam(
                    "base-coord",
                    `${newLatLng.lat}, ${newLatLng.lng}`
                  );
                }
              });
            }

            {
              const maxRentInput = document.querySelector("#max-rent-input");
              maxRentInput.value =
                new URL(location).searchParams.get("max-rent") ||
                defaultMaximumRent;
              maxRentInput.addEventListener("change", (event) => {
                if (parseInt(event.target.value, 10) !== NaN) {
                  setSearchParam("max-rent", event.target.value);
                }
              });
            }

            grid = new gridjs.Grid(getGridConfig()).render(tableDiv);
          }
        );
    </script>
  </body>
</html>
